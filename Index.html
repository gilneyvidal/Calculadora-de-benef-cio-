import locale

# ConfiguraÃ§Ã£o para formataÃ§Ã£o de moeda (BRL)
try:
    locale.setlocale(locale.LC_ALL, 'pt_BR.UTF-8')
except:
    # Fallback caso o ambiente nÃ£o tenha pt_BR
    pass

def formatar_moeda(valor):
    """Formata valores numÃ©ricos para o padrÃ£o de moeda brasileiro."""
    try:
        return locale.currency(valor, grouping=True)
    except:
        return f"R$ {valor:,.2f}".replace(",", "X").replace(".", ",").replace("X", ".")

class AnaliseCompraVeiculo:
    def __init__(self, veiculo, fipe, quitacao_total, debitos_detran=0, reparos_estimados=0, margem_lucro_minima=0.15):
        """
        Inicializa os dados da negociaÃ§Ã£o.
        
        :param veiculo: Modelo/Ano do carro (ex: "Honda Civic 2020")
        :param fipe: Valor de Tabela FIPE atual
        :param quitacao_total: Valor do boleto para quitaÃ§Ã£o Ã  vista (hoje)
        :param debitos_detran: IPVA, Multas, Licenciamento atrasado
        :param reparos_estimados: Funilaria, mecÃ¢nica, pneus
        :param margem_lucro_minima: % de lucro desejado sobre a FIPE (padrÃ£o 15%)
        """
        self.veiculo = veiculo
        self.fipe = fipe
        self.quitacao = quitacao_total
        self.debitos = debitos_detran
        self.reparos = reparos_estimados
        self.margem_minima = margem_lucro_minima
        
        # Custos Fixos Operacionais (CartÃ³rio, Despachante, CombustÃ­vel, Vistoria)
        self.custo_operacional_fixo = 1500.00 
        
        # Fator de Venda RÃ¡pida (DesÃ¡gio para girar rÃ¡pido abaixo da FIPE)
        self.fator_venda_rapida = 0.90  # Vender a 90% da FIPE

    def calcular_viabilidade(self):
        """Realiza o cÃ¡lculo reverso para encontrar o valor mÃ¡ximo a pagar ao lead."""
        
        # 1. Valor Real de Venda (Liquidez)
        valor_venda_projetado = self.fipe * self.fator_venda_rapida
        
        # 2. Custo ObrigatÃ³rio para "Limpar" o Carro
        custo_desoneracao = self.quitacao + self.debitos
        
        # 3. Custos de PreparaÃ§Ã£o e OperaÃ§Ã£o
        custo_preparacao = self.reparos + self.custo_operacional_fixo
        
        # 4. Lucro MÃ­nimo Esperado (Meta)
        lucro_meta = valor_venda_projetado * self.margem_minima
        
        # 5. O que sobra para o dono (Max Offer)
        # FÃ³rmula: Venda - (DÃ­vida Banco + DÃ©bitos + Reparos + Custos Ops + Meu Lucro)
        teto_pagamento_cliente = valor_venda_projetado - (custo_desoneracao + custo_preparacao + lucro_meta)
        
        # Resultados
        custo_total_projeto = custo_desoneracao + custo_preparacao + max(0, teto_pagamento_cliente)
        roi_projetado = ((valor_venda_projetado - custo_total_projeto) / custo_total_projeto) * 100
        
        return {
            "status": "VIÃVEL" if teto_pagamento_cliente > 0 else "INVIÃVEL / ARRISCADO",
            "teto_pagamento": teto_pagamento_cliente,
            "valor_venda_projetado": valor_venda_projetado,
            "custo_total": custo_total_projeto,
            "lucro_projetado": valor_venda_projetado - custo_total_projeto,
            "roi": roi_projetado
        }

    def gerar_relatorio(self):
        dados = self.calcular_viabilidade()
        
        print("="*60)
        print(f"RELATÃ“RIO DE INTELIGÃŠNCIA DE COMPRA: {self.veiculo.upper()}")
        print("="*60)
        
        print(f"1. ANÃLISE DE MERCADO")
        print(f"   Valor FIPE:.............. {formatar_moeda(self.fipe)}")
        print(f"   PreÃ§o Venda RÃ¡pida (90%):  {formatar_moeda(dados['valor_venda_projetado'])}")
        print("-" * 60)
        
        print(f"2. PASSIVO E CUSTOS")
        print(f"   QuitaÃ§Ã£o BancÃ¡ria:....... {formatar_moeda(self.quitacao)} (Pago direto ao Banco)")
        print(f"   DÃ©bitos Detran:.......... {formatar_moeda(self.debitos)}")
        print(f"   Reparos/Prep:............ {formatar_moeda(self.reparos)}")
        print(f"   Custos Adm/CartÃ³rio:..... {formatar_moeda(self.custo_operacional_fixo)}")
        print("-" * 60)
        
        print(f"3. RESULTADO DA ANÃLISE")
        if dados['teto_pagamento'] > 0:
            print(f"   âœ… STATUS: {dados['status']}")
            print(f"   ðŸ’° OFERTA SUGERIDA AO CLIENTE: {formatar_moeda(dados['teto_pagamento'])}")
            print(f"   ðŸ“ˆ Lucro Estimado: {formatar_moeda(dados['lucro_projetado'])} (ROI: {dados['roi']:.1f}%)")
        else:
            print(f"   â›” STATUS: {dados['status']}")
            print(f"   Motivo: O passivo supera o valor de mercado considerando custos e margem.")
            print(f"   DÃ©ficit: {formatar_moeda(dados['teto_pagamento'])}")
            print("   SugestÃ£o: Somente aceitar se o cliente pagar para entregar ou assumir dÃ­vida sem custo.")
        print("="*60)
        print("\n")
        
        return dados

    def gerar_proposta_whatsapp(self, nome_cliente):
        dados = self.calcular_viabilidade()
        
        if dados['teto_pagamento'] <= 0:
            return "âš ï¸ Proposta nÃ£o gerada. O negÃ³cio nÃ£o dÃ¡ lucro. Abortar operaÃ§Ã£o."

        # Script Persuasivo baseado nos dados reais
        msg = f"""
*PROPOSTA FORMAL DE COMPRA - {self.veiculo.upper()}*

OlÃ¡, {nome_cliente}. Fizemos a anÃ¡lise detalhada do seu caso junto ao jurÃ­dico e financeiro.

Para resolvermos sua situaÃ§Ã£o *hoje*, quitar sua dÃ­vida no banco e evitar/encerrar o processo judicial, conseguimos aprovar a seguinte operaÃ§Ã£o:

1ï¸âƒ£ *QuitaÃ§Ã£o Integral:* NÃ³s pagaremos Ã  vista o boleto de {formatar_moeda(self.quitacao)} diretamente ao Banco.
2ï¸âƒ£ *RegularizaÃ§Ã£o:* Assumiremos os dÃ©bitos de IPVA/Multas ({formatar_moeda(self.debitos)}) e os custos de transferÃªncia.
3ï¸âƒ£ *Seu "Troco":* AlÃ©m de limpar seu nome do financiamento, te pagaremos *{formatar_moeda(dados['teto_pagamento'])}* no PIX no ato da assinatura em cartÃ³rio.

*Resumo:* VocÃª se livra de uma dÃ­vida total de {formatar_moeda(self.quitacao + self.debitos)} e ainda sai com dinheiro no bolso.

Podemos agendar no cartÃ³rio para amanhÃ£? Essa proposta Ã© vÃ¡lida por 24h devido ao cÃ¡lculo do boleto bancÃ¡rio.
"""
        print("--- COPIE O TEXTO ABAIXO PARA O WHATSAPP ---")
        print(msg)
        print("--------------------------------------------")

# ==========================================
# ÃREA DE SIMULAÃ‡ÃƒO (PREENCHA AQUI SEUS DADOS)
# ==========================================

# Exemplo: Jeep Compass Longitude 2018
# CenÃ¡rio: Cliente deve 48x, mas quitaÃ§Ã£o Ã© 85k. Carro tem 3k de IPVA e precisa de 2k de pneus.

analise = AnaliseCompraVeiculo(
    veiculo="Jeep Compass 2018",
    fipe=110000.00,          # Valor de Tabela
    quitacao_total=75000.00, # Valor que o banco pede para quitar HOJE (nÃ£o a soma das parcelas)
    debitos_detran=3500.00,  # IPVA, Licenciamento, Multas
    reparos_estimados=2000.00, # Pneus, martelinho, polimento
    margem_lucro_minima=0.15   # Quero ganhar pelo menos 15% sobre a venda
)

# Executa o sistema
dados_finais = analise.gerar_relatorio()

# Se deu bom, gera o texto pro cliente
if dados_finais['teto_pagamento'] > 0:
    analise.gerar_proposta_whatsapp(nome_cliente="Carlos")
